```javascript
(function(){
  'use strict';
  var state = { gender:'', ageType:'', ageYears:null };
  var ageMap = {
    adult:{unit:'Years',placeholder:'나이(년)',labelOut:'Adult',factor:1,suffix:'y'},
    infant:{unit:'Months',placeholder:'나이(개월)',labelOut:'Infant',factor:1/12,suffix:'m'},
    neonate:{unit:'Days',placeholder:'나이(일)',labelOut:'NEONATE',factor:1/365,suffix:'d'}
  };

  function $(sel){return document.querySelector(sel)}
  var form=$('#myForm'), ageValueInput=$('#ageValue'), ageUnitSpan=$('#ageUnit');
  var patientSexAgeDiv=$('#patientSexAge'), patientBodyDiv=$('#patientBody');
  var heightInput=$('#height'), bwtInput=$('#bwt');

  function getSexShort(g){return g==='Male'?'M':g==='Female'?'F':''}
  function setChips(groupEl,value){
    groupEl.querySelectorAll('.chip').forEach(function(btn){
      var checked=btn.dataset.value===value;
      btn.setAttribute('aria-checked',checked);
      btn.classList.toggle('active',checked);
    });
  }
  function updateAgeUI(){
    var cfg=ageMap[state.ageType]||{};
    ageUnitSpan.textContent=cfg.unit||'';
    ageValueInput.placeholder=cfg.placeholder||'숫자 입력';
  }
  function parseIntStrict(str){
    var n=Number(str);
    return Number.isInteger(n)?n:NaN;
  }

  function roundToOne(num){return Math.round(num*10)/10}
  function formatOne(num){return Number.isInteger(num)?String(num):num.toFixed(1)}
  function validateHW(hStr,wStr){
    if(!hStr||!wStr) return {ok:false};
    var h=parseFloat(hStr), w=parseFloat(wStr);
    if(!isFinite(h)||!isFinite(w)||h<0.1||w<0.1) return {ok:false};
    return {ok:true,text:formatOne(roundToOne(h))+"cm/"+formatOne(roundToOne(w))+"kg"};
  }

  document.addEventListener('click',function(e){
    var btn=e.target.closest('.chip');
    if(!btn) return;
    var group=btn.closest('.chips');
    var key=group?group.getAttribute('data-target'):'';
    if(!key) return;
    state[key]=btn.dataset.value;
    setChips(group,state[key]);
    if(key==='ageType') updateAgeUI();
  });

  document.addEventListener('keydown',function(e){
    if((e.key===' '||e.key==='Enter')&&e.target.classList.contains('chip')){
      e.preventDefault();
      e.target.click();
    }
  });

  form.addEventListener('submit',function(e){
    e.preventDefault();
    var gender=state.gender, ageType=state.ageType, ageRawStr=(ageValueInput.value||'').trim();
    if(!gender||!ageType||ageRawStr===''){
      patientSexAgeDiv.textContent='성별 연령구분 나이를 입력하세요';
      return;
    }
    var ageRawNum=parseIntStrict(ageRawStr);
    if(!Number.isInteger(ageRawNum)||ageRawNum<=0){
      patientSexAgeDiv.textContent='나이를 정확히 입력하세요';
      return;
    }
    var cfg=ageMap[ageType];
    state.ageYears=ageRawNum*cfg.factor;
    var Sex=getSexShort(gender);
    var display='';
    if(ageType==='adult') display=cfg.labelOut+' / '+Sex+' / '+state.ageYears+'y';
    else if(ageType==='infant') display=cfg.labelOut+' / '+Sex+' / '+ageRawNum+'m';
    else if(ageType==='neonate') display=cfg.labelOut+' / '+Sex+' / '+ageRawNum+'d';
    patientSexAgeDiv.textContent=display;
  });

  document.getElementById('applyBtnBody').addEventListener('click',function(){
    var result=validateHW(heightInput.value.trim(),bwtInput.value.trim());
    patientBodyDiv.textContent=result.ok?result.text:'키 체중을 정확히 입력하세요';
    updateBSA();
  });

  function getSelectedBSAMethod(){
    var el=document.querySelector('input[name="bsaMethod"]:checked');
    return el?el.value:'mostellar';
  }
  function computeBSAValue(h,w,m){
    if(!isFinite(h)||!isFinite(w)||h<=0||w<=0) return null;
    if(m==='mostellar') return Math.sqrt(h*w/3600);
    if(m==='dubois') return 0.007184*Math.pow(h,0.725)*Math.pow(w,0.425);
    if(m==='haycock') return 0.024265*Math.pow(h,0.3964)*Math.pow(w,0.5378);
    return null;
  }
  function formatBSAOutput(val){
    return(!val||!isFinite(val))?'BSA = --/m²':'BSA = '+(Math.round(val*100)/100).toFixed(2)+'/m²';
  }
  function updateBSA(){
    var h=parseFloat(heightInput.value), w=parseFloat(bwtInput.value), method=getSelectedBSAMethod();
    var el=document.getElementById('patientBSA');
    if(!isFinite(h)||!isFinite(w)||h<0.1||w<0.1){
      el.textContent='BSA = --/m²';
      return;
    }
    el.textContent=formatBSAOutput(computeBSAValue(roundToOne(h),roundToOne(w),method));
  }
  document.getElementById('bsaMethodGroup').addEventListener('change',updateBSA);

  updateAgeUI();
  updateBSA();
})();