<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sejong Anesthesiology Calculator</title>

  <style>
    :root {
      --primary-blue: #0052cc;
      --primary-white: #ffffff;
      --secondary-blue: #e3f2fd;
      --text-primary: #1565c0;
      --text-secondary: #424242;
      --border-color: #bbdefb;
      --error-color: #d32f2f;
      --success-color: #388e3c;
    }

    body {
      font-family: Arial, sans-serif;
      margin: 40px 0;
      background: #f2f2f2;
    }

    .container {
      width: 1600px;
      margin: 0 auto;
      padding: 20px;
    }

    .title-box {
      font-size: 24px;
      font-weight: 700;
      background: var(--primary-blue);
      color: var(--primary-white);
      padding: 8px 16px;
      display: flex;
      align-items: center;
    }

    .sub-title {
      margin: 0 0 8px 0;
      font-size: 18px;
      font-weight: 700;
      background: var(--primary-blue);
      color: var(--primary-white);
      padding: 4px 8px;
    }

    .top-layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      margin-bottom: 24px;
    }

    .col1-2 {
      background: var(--primary-blue);
      color: #c9d6ff;
      text-align: right;
      padding: 8px 16px;
      font-size: 12px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      line-height: 1.35;
    }

    .layout {
      display: grid;
      grid-template-columns: 300px 1fr 1fr 1fr 1fr;
      gap: 12px;
      margin-bottom: 24px;
    }

    .col2-card {
      background: var(--primary-white);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 12px;
    }

    .col2-1 img {
      width: 300px;
      height: auto;
      display: block;
      object-fit: contain;
    }

    .age-row {
      display: flex;
      align-items: center;
      gap: 6px;
      justify-content: center;
    }

    input[type="number"] {
      width: 50%;
      padding: 6px;
      margin-left: 10px;
      border: 2px solid var(--border-color);
      border-radius: 4px;
    }

    input[type="number"]:focus {
      outline: 2px solid var(--primary-blue);
      outline-offset: 2px;
      border-color: var(--primary-blue);
    }

    .chips {
      display: flex;
      gap: 6px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .chip {
      border: 1px solid #888;
      padding: 6px 12px;
      border-radius: 999px;
      background: var(--primary-white);
      cursor: pointer;
      user-select: none;
      transition: all 0.2s ease;
    }

    .chip:focus {
      outline: 2px solid var(--primary-blue);
      outline-offset: 2px;
    }

    .chip.active {
      background: var(--primary-blue);
      color: var(--primary-white);
      border-color: var(--primary-blue);
    }

    .apply-btn {
      margin: 20px auto 0;
      display: block;
      width: 120px;
      padding: 6px 10px;
      font-size: 14px;
      cursor: pointer;
      background: var(--primary-blue);
      color: var(--primary-white);
      border: none;
      border-radius: 4px;
    }

    .apply-btn:focus {
      outline: 2px solid var(--primary-blue);
      outline-offset: 2px;
    }

    .patient-info-line {
      margin-top: 8px;
      font-size: 16px;
      font-weight: 600;
      white-space: pre-line;
      color: var(--text-primary);
    }

    .radio-group {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-top: 8px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .radio-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .info-text {
      font-size: 14px;
      font-weight: 400;
      color: var(--text-secondary);
      margin: 8px 0;
      text-align: center;
      background: var(--secondary-blue);
      padding: 8px;
      border: none;
      border-radius: 4px;
    }

    /* 폼 테이블 좌측 라벨 셀 */
    .form-table .label-cell {
      text-align: center;
      font-weight: 600;
      vertical-align: middle;
      color: var(--text-primary);
    }

    /* 검증 피드백 스타일 */
    .validation-feedback {
      font-size: 12px;
      margin-top: 4px;
      padding: 4px 8px;
      border-radius: 4px;
    }

    .validation-feedback.invalid {
      background-color: #ffebee;
      color: var(--error-color);
      border-left: 3px solid var(--error-color);
    }

    .validation-feedback.valid {
      background-color: #e8f5e8;
      color: var(--success-color);
      border-left: 3px solid var(--success-color);
    }

    /* 에러 메시지 스타일 */
    .error-message {
      color: var(--error-color);
      font-weight: 500;
      margin-top: 4px;
    }

    /* 개발용 테스트 영역 */
    details {
      margin-top: 16px;
      padding: 12px;
      background: var(--secondary-blue);
      border-radius: 6px;
    }

    summary {
      font-weight: 600;
      color: var(--text-primary);
      cursor: pointer;
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- 상단 타이틀 2컬럼 -->
    <div class="top-layout">
      <div class="title-box">Sejong Anesthesiology Calculator</div>
      <div class="col1-2">
        <div>Ver. 0.1 Build 2509-0021</div>
        <div>2025/09/13 · Dr. Min</div>
      </div>
    </div>

    <!-- 상단 5컬럼 -->
    <div class="layout">
      <!-- col 2-1: 로고 -->
      <div class="col2-1 col2-card">
        <img alt="로고" src="purmi.png" width="300" style="width:300px;height:auto;object-fit:contain;" />
      </div>

      <!-- col 2-2: 성별/연령/연령대 -->
      <div class="col2-2 col2-card">
        <h2 class="sub-title">성별, 연령, 연령대</h2>
        <form id="myForm" novalidate>
          <table class="form-table" style="width:100%;table-layout:fixed;">
            <colgroup>
              <col style="width:30%" />
              <col style="width:70%" />
            </colgroup>

            <!-- 행 1: 성별 -->
            <tr>
              <td class="label-cell">성별</td>
              <td>
                <div class="chips" data-target="gender" role="radiogroup" aria-label="성별 선택">
                  <button type="button" class="chip" data-value="Male" role="radio" aria-checked="false">Male</button>
                  <button type="button" class="chip" data-value="Female" role="radio" aria-checked="false">Female</button>
                </div>
              </td>
            </tr>

            <!-- 행 2: 연령구분 -->
            <tr>
              <td class="label-cell">연령<br>구분</td>
              <td>
                <div class="chips" data-target="ageType" role="radiogroup" aria-label="연령 구분 선택">
                  <button type="button" class="chip" data-value="adult" role="radio" aria-checked="false">Adult</button><br>
                  <button type="button" class="chip" data-value="infant" role="radio" aria-checked="false">Infant</button>
                  <button type="button" class="chip" data-value="neonate" role="radio" aria-checked="false">Neonate</button>
                </div>
              </td>
            </tr>

            <!-- 행 3: 나이 + 단위 -->
            <tr>
              <td class="label-cell">나이</td>
              <td>
                <div class="age-row">
                  <input type="number" id="ageValue" min="1" step="1" inputmode="numeric" />
                  <span id="ageUnit"></span>
                </div>
              </td>
            </tr>
          </table>

          <button type="submit" class="apply-btn">적용</button>
          <div id="ageErrorMessage" class="error-message"></div>
        </form>
      </div>

      <!-- col 2-3: 신체치수 -->
      <div class="col2-3 col2-card">
        <h2 class="sub-title">신체치수</h2>

        <label>
          키
          <div class="age-row">
            <input type="number" id="height" min="0.1" step="0.1" inputmode="decimal" />
            <span>cm</span>
          </div>
        </label>

        <label>
          체중
          <div class="age-row">
            <input type="number" id="bwt" min="0.1" step="0.1" inputmode="decimal" />
            <span>kg</span>
          </div>
        </label>

        <button type="button" id="applyBtnBody" class="apply-btn">적용</button>
        <div id="bodyErrorMessage" class="error-message"></div>

        <div class="info-text">
          키, 체중은 소수점 첫째 자리까지 가능<br>
          둘째 자리 이상 입력하면<br>
          자동으로 반올림 처리됩니다.
        </div>
      </div>

      <!-- col 2-4: 환자정보 -->
      <div class="col2-4 col2-card">
        <h2 class="sub-title">환자정보</h2>
        <div id="patientSexAge" class="patient-info-line"></div>
        <div id="patientBody" class="patient-info-line"></div>

        <h3 class="sub-title">BSA</h3>
        <div id="bsaMethodGroup" class="radio-group" role="radiogroup" aria-label="BSA 계산 공식">
          <label class="radio-item"><input type="radio" name="bsaMethod" value="mostellar" checked> Mostellar</label>
          <label class="radio-item"><input type="radio" name="bsaMethod" value="dubois"> Du Bois</label>
          <label class="radio-item"><input type="radio" name="bsaMethod" value="haycock"> Haycock</label>
        </div>
        <div id="patientBSA" class="patient-info-line"></div>
        <div id="bsaWarning" class="validation-feedback" style="display: none;"></div>
      </div>

      <!-- col 2-5: 추가 영역 -->
      <div class="col2-5 col2-card">
        <h2 class="sub-title">계산 공식 정보</h2>
        <div style="font-size: 12px; line-height: 1.4; color: var(--text-secondary);">
          <p><strong>Mostellar:</strong><br>√(키×체중/3600)</p>
          <p><strong>Du Bois:</strong><br>0.007184×키^0.725×체중^0.425</p>
          <p><strong>Haycock:</strong><br>0.024265×키^0.3964×체중^0.5378</p>
        </div>
      </div>
    </div>

    <!-- col 3-0: Acting Information -->
    <div class="title-box">계산 결과 정보</div>

    <!-- 개발용 테스트 -->
    <details id="dev-tests">
      <summary>개발용 테스트 보기</summary>
      <ul id="test-results"></ul>
    </details>
  </div>

  <script>
    (function () {
      'use strict';

      // 상태 및 매핑
      var state = { gender: '', ageType: '', ageYears: null };
      var ageMap = {
        adult:   { unit: 'Years',  placeholder: '나이(년)',  labelOut: 'Adult',   factor: 1,     suffix: 'y', max: 150 },
        infant:  { unit: 'Months', placeholder: '나이(개월)', labelOut: 'Infant',  factor: 1/12,  suffix: 'm', max: 120 },
        neonate: { unit: 'Days',   placeholder: '나이(일)',  labelOut: 'NEONATE', factor: 1/365, suffix: 'd', max: 365 }
      };

      // DOM 헬퍼
      function $(sel) { return document.querySelector(sel); }
      var form = $('#myForm');
      var ageValueInput = $('#ageValue');
      var ageUnitSpan   = $('#ageUnit');
      var patientSexAgeDiv = $('#patientSexAge');
      var patientBodyDiv   = $('#patientBody');
      var heightInput = $('#height');
      var bwtInput    = $('#bwt');
      var ageErrorDiv = $('#ageErrorMessage');
      var bodyErrorDiv = $('#bodyErrorMessage');
      var bsaWarningDiv = $('#bsaWarning');

      // 유틸
      function getSexShort(g) {
        return (g === 'Male') ? 'M' : (g === 'Female') ? 'F' : '';
      }
      
      function setChips(groupEl, value) {
        groupEl.querySelectorAll('.chip').forEach(function (btn) {
          var checked = (btn.dataset.value === value);
          btn.setAttribute('aria-checked', checked);
          btn.classList.toggle('active', checked);
        });
      }
      
      function updateAgeUI() {
        var cfg = ageMap[state.ageType] || {};
        ageUnitSpan.textContent = cfg.unit || '';
        ageValueInput.placeholder = cfg.placeholder || '숫자 입력';
        ageValueInput.max = cfg.max || 150;
      }
      
      function parseIntStrict(str) {
        var n = Number(str);
        return Number.isInteger(n) ? n : NaN;
      }

      // 검증 함수들
      function validateAge(ageType, ageValue) {
        if (!ageType) return '연령 구분을 선택해주세요';
        if (!ageValue) return '나이를 입력해주세요';
        
        var numAge = parseIntStrict(ageValue);
        if (isNaN(numAge) || numAge <= 0) return '양수 값을 입력해주세요';
        
        var cfg = ageMap[ageType];
        if (numAge > cfg.max) {
          var unitName = ageType === 'adult' ? '년' : ageType === 'infant' ? '개월' : '일';
          return unitName + '은 ' + cfg.max + ' 이하로 입력해주세요';
        }
        return null;
      }

      function validateBodyMeasurements(height, weight) {
        if (!height) return '키를 입력해주세요';
        if (!weight) return '체중을 입력해주세요';
        
        var h = parseFloat(height);
        var w = parseFloat(weight);
        
        if (isNaN(h) || h < 10 || h > 300) return '키는 10-300cm 범위로 입력해주세요';
        if (isNaN(w) || w < 0.5 || w > 500) return '체중은 0.5-500kg 범위로 입력해주세요';
        
        return null;
      }

      // 피드백 표시 함수
      function showValidationFeedback(element, message, isValid) {
        if (message) {
          element.textContent = message;
          element.style.display = 'block';
        } else {
          element.style.display = 'none';
        }
      }

      // 키/체중: 소수 둘째 자리 이상 입력 시 자동 반올림(1자리)
      function roundToOne(num) { return Math.round(num * 10) / 10; }
      function formatOne(num) { return Number.isInteger(num) ? String(num) : num.toFixed(1); }
      function validateHW(hStr, wStr) {
        var error = validateBodyMeasurements(hStr, wStr);
        if (error) return { ok: false, error: error };
        
        var h = parseFloat(hStr), w = parseFloat(wStr);
        return { ok: true, text: formatOne(roundToOne(h)) + 'cm / ' + formatOne(roundToOne(w)) + 'kg' };
      }

      // 칩 클릭/키보드 이벤트
      document.addEventListener('click', function (e) {
        var btn = e.target.closest('.chip');
        if (!btn) return;
        var group = btn.closest('.chips');
        var key = group ? group.getAttribute('data-target') : '';
        if (!key) return;
        state[key] = btn.dataset.value;
        setChips(group, state[key]);
        if (key === 'ageType') updateAgeUI();
        
        // 에러 메시지 클리어
        if (key === 'gender' || key === 'ageType') {
          showValidationFeedback(ageErrorDiv, null, true);
        }
      });
      
      document.addEventListener('keydown', function (e) {
        if ((e.key === ' ' || e.key === 'Enter') && e.target.classList.contains('chip')) {
          e.preventDefault();
          e.target.click();
        }
      });

      // 제출(성별/나이 표기)
      form.addEventListener('submit', function (e) {
        e.preventDefault();
        var gender = state.gender;
        var ageType = state.ageType;
        var ageRawStr = (ageValueInput.value || '').trim();

        // 검증
        var ageError = validateAge(ageType, ageRawStr);
        if (!gender) {
          ageError = '성별을 선택해주세요';
        }
        
        if (ageError) {
          showValidationFeedback(ageErrorDiv, ageError, false);
          return;
        }

        var ageRawNum = parseIntStrict(ageRawStr);
        var cfg = ageMap[ageType];
        state.ageYears = ageRawNum * cfg.factor;

        var Sex = getSexShort(gender);
        var display = '';
        if (ageType === 'adult') {
          display = cfg.labelOut + ' / ' + Sex + ' / ' + state.ageYears + 'y';
        } else if (ageType === 'infant') {
          display = cfg.labelOut + ' / ' + Sex + ' / ' + ageRawNum + 'm';
        } else if (ageType === 'neonate') {
          display = cfg.labelOut + ' / ' + Sex + ' / ' + ageRawNum + 'd';
        }
        patientSexAgeDiv.textContent = display;
        showValidationFeedback(ageErrorDiv, null, true);
      });

      // 신체치수 적용 버튼
      $('#applyBtnBody').addEventListener('click', function () {
        var result = validateHW(heightInput.value.trim(), bwtInput.value.trim());
        if (result.ok) {
          patientBodyDiv.textContent = result.text;
          showValidationFeedback(bodyErrorDiv, null, true);
          updateBSA();
        } else {
          showValidationFeedback(bodyErrorDiv, result.error, false);
        }
      });

      // BSA 계산
      function getSelectedBSAMethod() {
        var el = document.querySelector('input[name="bsaMethod"]:checked');
        return el ? el.value : 'mostellar';
      }
      
      function computeBSAValue(h, w, m) {
        if (!isFinite(h) || !isFinite(w) || h <= 0 || w <= 0) return null;
        if (m === 'mostellar') return Math.sqrt(h * w / 3600);
        if (m === 'dubois')    return 0.007184 * Math.pow(h, 0.725) * Math.pow(w, 0.425);
        if (m === 'haycock')   return 0.024265 * Math.pow(h, 0.3964) * Math.pow(w, 0.5378);
        return null;
      }
      
      function formatBSAOutput(val) {
        return (!val || !isFinite(val))
          ? 'BSA = --/m²'
          : 'BSA = ' + (Math.round(val * 100) / 100).toFixed(2) + '/m²';
      }
      
      function checkBSARange(bsaValue) {
        if (!bsaValue || !isFinite(bsaValue)) return null;
        
        // 일반적인 BSA 범위 (성인: 1.4-2.5 m², 소아: 더 넓은 범위)
        if (bsaValue < 0.1) return '계산된 BSA가 매우 낮습니다. 입력값을 확인해주세요.';
        if (bsaValue > 3.0) return '계산된 BSA가 매우 높습니다. 입력값을 확인해주세요.';
        if (bsaValue > 2.5) return '일반적 범위보다 높은 BSA입니다.';
        if (bsaValue < 0.2) return '일반적 범위보다 낮은 BSA입니다.';
        
        return null;
      }
      
      function updateBSA() {
        var h = parseFloat(heightInput.value);
        var w = parseFloat(bwtInput.value);
        var method = getSelectedBSAMethod();
        var el = document.getElementById('patientBSA');
        
        if (!isFinite(h) || !isFinite(w) || h < 0.1 || w < 0.1) {
          el.textContent = 'BSA = --/m²';
          bsaWarningDiv.style.display = 'none';
          return;
        }
        
        var bsaValue = computeBSAValue(roundToOne(h), roundToOne(w), method);
        el.textContent = formatBSAOutput(bsaValue);
        
        // BSA 범위 체크 및 경고
        var warning = checkBSARange(bsaValue);
        if (warning) {
          bsaWarningDiv.textContent = warning;
          bsaWarningDiv.className = 'validation-feedback invalid';
          bsaWarningDiv.style.display = 'block';
        } else {
          bsaWarningDiv.style.display = 'none';
        }
      }
      
      document.getElementById('bsaMethodGroup').addEventListener('change', updateBSA);

      // 입력 필드 실시간 검증
      heightInput.addEventListener('input', function() {
        showValidationFeedback(bodyErrorDiv, null, true);
      });
      
      bwtInput.addEventListener('input', function() {
        showValidationFeedback(bodyErrorDiv, null, true);
      });
      
      ageValueInput.addEventListener('input', function() {
        showValidationFeedback(ageErrorDiv, null, true);
      });

      // 초기화
      updateAgeUI();
      updateBSA();
    })();
  </script>
</body>
</html>